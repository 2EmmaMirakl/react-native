<!doctype html>
<!--
  Copyright (c) 2015-present, Facebook, Inc.
  All rights reserved.

  This source code is licensed under the BSD-style license found in the
  LICENSE file in the root directory of this source tree. An additional grant
  of patent rights can be found in the PATENTS file in the same directory.
-->

<html>
<head>
<meta charset=utf-8>
<!-- Fake favicon, to avoid extra request to server -->
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<title>React Native Debugger</title>
<script>
(function() {

var head = document.getElementsByTagName('head')[0];

function loadScript(url, callback) {
  // Adding the script tag to the head as suggested before
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = url;

  script.onreadystatechange = callback;
  script.onload = callback;

  head.appendChild(script);
}

function setStatus(status) {
  document.getElementById('status').innerHTML = status;
}

function connectToDebuggerProxy() {

  var enqueueMethod = function(message) {
    this.methodQueue.push(message);
  };

  var executeMethod = function(message) {
    var method = window.__fbBatchedBridge[message.method];
    if (!method) {
      throw Error('Unknown method: ' + message.method);
    }
    var result = [[], [], [], [], []];
    try {
      result = method.apply(null, message.arguments);
    } finally {
      this.sendReply(message, {
        result: JSON.stringify(result),
      });
    }
  };

  var ws = new WebSocket('ws://' + window.location.host + '/debugger-proxy?role=debugger&name=Chrome');

  window.Debugger = {
    socket: ws,
    methodQueue: [],
    executeMethod: enqueueMethod,
    onMessage: function(message) {
      var method = this.specialMethods[message.method] || this.executeMethod;
      method.call(this, message);
    },
    sendMessage: function(data) {
      ws.send(JSON.stringify(data));
    },
    sendReply: function(message, data) {
      if (data === undefined) { data = {}; }
      data.replyID = message.id;
      this.sendMessage(data);
    },
    shutdownJSRuntime: function() {
      if (window.isReloading) { return; }
      window.isReloading = true;
      window.location.reload();
    },
    specialMethods: {
      prepareJSRuntime: function(message) {
        if (window.__fbBatchedBridge) {
          return this.shutdownJSRuntime();
        }
        setStatus('Debugger session #' + message.id + ' active.');
        this.sendReply(message);
      },
      $disconnected: function() {
        this.shutdownJSRuntime();
      },
      executeApplicationScript: function(message) {
        if (window.isReloading) { return; }
        var self = this;
        for (var key in message.inject) {
          window[key] = JSON.parse(message.inject[key]);
        }
        loadScript(message.url, function() {
          self.executeMethod = executeMethod;
          if (!self.methodQueue.length) {
            return;
          }
          self.methodQueue.forEach(function(message) {
            try {
              self.executeMethod(message);
            } catch (error) {
              console.warn(error.message);
              self.sendReply(message);
            }
          });
          self.methodQueue = [];
        });
        self.sendReply(message);
      },
    },
  };

  var INITIAL_MESSAGE = 'Waiting, press <span class="shortcut">⌘R</span> in simulator to reload and connect.';

  ws.onopen = function() {
    setStatus(INITIAL_MESSAGE);
  };

  ws.onmessage = function(message) {
    if (!message.data) {
      return;
    }
    message = JSON.parse(message.data);
    if (message.$event === 'client-disconnected') {
      setStatus('Waiting, press <span class="shortcut">⌘R</span> in simulator to reload and connect.');
      Debugger.shutdownJSRuntime();
    } else if (message.method) {
      Debugger.onMessage(message);
    }
  };

  ws.onclose = function(e) {
    setStatus('Disconnected from proxy. Attempting reconnection. Is node server running?');
    if (e.reason) {
      setStatus(e.reason);
      console.warn(e.reason);
    }
    console.log('ws.onclose()');
    Debugger.shutdownJSRuntime();
  };
}

connectToDebuggerProxy();

})();
</script>
<style type="text/css">
  body {
    font-size: large;
    margin: 0;
    padding: 0;
    font-family: Helvetica, Verdana, sans-serif;
    font-weight: 200;
  }
  .content {
    padding: 10px;
  }
</style>
</head>
<body>
  <div class="content">
    <p>Status: <span id="status">Loading...</span></p>
    <button onclick="NativeModules.DevMenu.reload()">Reload app</button>
  </div>
</body>
</html>
